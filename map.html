<div id="map" style="height: 600px;"></div>
<div id="output" style="padding: 1em;"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
  const output = document.getElementById('output');
  let countryData = {};

  fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQXIQ9fnxot2VSAp-RtkOWdqryOiOzrHl11jqVszXfTH5WFJY3XiP3Eu6ULKwsEEz1Hfe51U5ViDjYa/pub?output=csv')
    .then(response => response.text())
    .then(csv => {
      Papa.parse(csv, {
        header: true,
        complete: function(results) {
          results.data.forEach(row => {
            if (row.Country && row.Category) {
              countryData[row.Country.trim()] = parseFloat(row.Category);
            }
          });

          output.innerHTML = "Data loaded. Rendering map...";
          loadMap();
        },
        error: err => {
          output.innerHTML = "Error parsing CSV: " + err.message;
        }
      });
    })
    .catch(err => {
      output.innerHTML = "Failed to fetch CSV: " + err.message;
    });

  function loadMap() {
    var map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
      .then(res => res.json())
      .then(geoData => {
        function getColor(d) {
          return d > 1000 ? '#800026' :
                 d > 500  ? '#BD0026' :
                 d > 200  ? '#E31A1C' :
                 d > 100  ? '#FC4E2A' :
                 d > 50   ? '#FD8D3C' :
                 d > 20   ? '#FEB24C' :
                 d > 10   ? '#FED976' :
                            '#FFEDA0';
        }

        function style(feature) {
          const name = feature.properties.name;
          const value = countryData[name] || 0;
          return {
            fillColor: getColor(value),
            weight: 1,
            opacity: 1,
            color: 'white',
            dashArray: '2',
            fillOpacity: 0.7
          };
        }

        function onEachFeature(feature, layer) {
          const name = feature.properties.name;
          const value = countryData[name] || "No data";
          layer.bindPopup(`<strong>${name}</strong><br/>Value: ${value}`);
        }

        L.geoJson(geoData, {
          style: style,
          onEachFeature: onEachFeature
        }).addTo(map);
      });
  }
</script>
